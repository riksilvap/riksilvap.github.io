<p>
  <button class="btn btn-lg btn-default" onclick="conectar()">Conectar8()</button>
</p>
<p>
  <button class="btn btn-lg btn-default" onclick="sendTextData('testes....testes....testes....testes....testes....testes....testes....testes....testes....')">Escreva</button>
</p>
<p>
  <button class="btn btn-lg btn-default" onclick="sendtextarea()">sendtextarea</button>
</p>
<textarea id="target" ></textarea>


<script type="text/javascript">
  
let printCharacteristic;
let index = 0;
let data;

function handleError(error) {
  console.log(error);
  document.querySelector('#target').value += 'error' + error ;

}

function sendtextarea(){
   sendTextData(document.querySelector('#target').value);
}
function mostralog(line){
   document.querySelector('#target').value += line ;
};

function sendTextData(texto) {
  // Get the bytes for the text
  let encoder = new TextEncoder("utf-8");
  // Add line feed + carriage return chars to text
  let text = encoder.encode(texto + '\u000A\u000D');
  return printCharacteristic.writeValue(text).then(() => {
    mostralog('Write done.');
  });
}
//e7810a71-73ae-499d-8c15-faa9aef0c3f2
//000018f0-0000-1000-8000-00805f9b34fb
function conectar () {
  if (printCharacteristic == null) {
    let options = {
      optionalServices: ['e7810a71-73ae-499d-8c15-faa9aef0c3f2'],
      "acceptAllDevices": true
    };
    navigator.bluetooth.requestDevice(options)
    .then(device => {
      mostralog('> Found ' + device.name);
      mostralog('Connecting to GATT Server...');
      return device.gatt.connect();
    })
    
    .then(server => server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb"))
    .then(service => service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"))
    .then(characteristic => {
      // Cache the characteristic
      printCharacteristic = characteristic;
      sendTextData('Lorem Ipsum é simplesmente uma simulação de texto da indústria tipográfica e de impressos, e vem sendo utilizado desde o século XVI, quando um impressor desconhecido pegou uma bandeja de tipos e os embaralhou para fazer um livro de modelos de tipos. Lorem Ipsum sobreviveu não só a cinco séculos, como também ao salto para a editoração eletrônica, permanecendo essencialmente inalterado. Se popularizou na década de 60, quando a Letraset lançou decalques contendo passagens de Lorem Ipsum, e mais recentemente quando passou a ser integrado a softwares de editoração eletrônica como Aldus PageMaker.');
    })
    .catch(handleError);
  } else {
    sendTextData('Segundo testeSegundo testeSegundo \n\n\ntesteSegundo testeSegundo testeSegundo teste');
  }
};
</script>
