<p>
  <button class="btn btn-lg btn-default" onclick="conectar()">Conectar()</button>
</p>
<p>
  <button class="btn btn-lg btn-default" onclick="sendTextData('testes....testes....testes....testes....testes....testes....testes....testes....testes....')">Escreva</button>
</p>
<p>
  <button class="btn btn-lg btn-default" onclick="sendtextarea()">sendtextarea</button>
</p>
<textarea id="target" ></textarea>


<script type="text/javascript">
  
let printCharacteristic;
let index = 0;
let data;

function handleError(error) {
  console.log(error);
  document.querySelector('#target').value += 'error' + error + '\n';

}

function sendtextarea(){
   sendTextData(document.querySelector('#target').value);
}
function mostralog(line){
   document.querySelector('#target').value += line + '\n';
};

function sendTextData(texto) {
  // Get the bytes for the text
  let encoder = new TextEncoder("utf-8");
  // Add line feed + carriage return chars to text
  let text = encoder.encode(texto + '\u000A\u000D');
  return printCharacteristic.writeValue(text).then(() => {
    mostralog('Write done.');
  });
}

function conectar () {
  if (printCharacteristic == null) {
    let options = {
      "acceptAllDevices": true
    };
    navigator.bluetooth.requestDevice(options)
    .then(device => {
      mostralog('> Found ' + device.name);
      mostralog('Connecting to GATT Server...');
      return device.gatt.connect();
    })
    .then(server => server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb"))
    .then(service => service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"))
    .then(characteristic => {
      // Cache the characteristic
      printCharacteristic = characteristic;
      sendPrinterData('Isso é um teste...Isso é um teste...Isso é um teste...Isso é um teste...');
    })
    .catch(handleError);
  } else {
    sendPrinterData('Segundo testeSegundo testeSegundo testeSegundo testeSegundo testeSegundo teste');
  }
};
</script>
