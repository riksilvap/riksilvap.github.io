<p>
  <button class="btn btn-lg btn-default" onclick="readBatteryLevel()">Conectar6</button>
</p>
<p>
  <button class="btn btn-lg btn-default" onclick="escreva2('testes....testes....testes....testes....testes....testes....testes....testes....testes....')">Escreva</button>
</p>
<p>
  <button class="btn btn-lg btn-default" onclick="mostralog('testes.')">Alert</button>
</p>
<p id="target"></p>

<script type="text/javascript">
  class GenericDevice {

  constructor() {
    this.device = null;
    this.onDisconnected = this.onDisconnected.bind(this);
  }
  //BluetoothRemoteGATTCharacteristic.writeValue()
  request() {
    let options = {
      "acceptAllDevices": true
    };
    return navigator.bluetooth.requestDevice(options)
    .then(device => {
      this.device = device;
      this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
    });
  }
  
  connect() {
    if (!this.device) {
      return Promise.reject('Device is not connected.');
    }
    return this.device.gatt.connect();
  }
  
  readTeste() {
    return this.device.gatt.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb")
    .then(service => service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"))
    .then(characteristic => characteristic.readValue());
  }
  
  writeTeste2(){
    return this.device.gatt.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb")
    .then(service => service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"))
    .then(characteristic => {
      let encoder = new TextEncoder("utf-8");
          // Add line feed + carriage return chars to text
          let text = encoder.encode(message.value + '\u000A\u000D');
          return printCharacteristic.writeValue(text).then(() => {
            console.log('Write done.');
          });
      let encoder = new TextEncoder('utf-8');
         let userDescription = encoder.encode('Defines the time between measurements.');
         return characteristic.writeValue(userDescription);
      });
  }
  writeTeste(data) {
    return this.device.gatt.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb")
    .then(service => service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"))
    .then(characteristic => {
      var value = new ByteArray();
      value.writeUTFBytes( data );
      characteristic.writeValue(value)
    });
      
  }

  disconnect() {
    if (!this.device) {
      return Promise.reject('Device is not connected.');
    }
    return this.device.gatt.disconnect();
  }

  onDisconnected() {
    mostralog('Device is disconnected.');
  }
}

function mostralog(line){
   document.querySelector('#target').textContent += line + '\n';
};
var genericDevice = new GenericDevice();
  let printCharacteristic;
function readBatteryLevel(){
  genericDevice.request()
  .then(_ => genericDevice.connect())
  .then(_ => { mostralog('/* Do something with genericDevice... */')})
//   .then(server => {
//     mostralog('server.getPrimaryService');
//       server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb")
//   })
//   .then(service => {
//     mostralog('service.getCharacteristic("000018f0-0000-1000-8000-00805f9b34fb"');
//     service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb")
//   })
  .then(characteristic => {
    // Cache the characteristic
    mostralog('characteristic');
    printCharacteristic = characteristic;
    let encoder = new TextEncoder("utf-8");
    // Add line feed + carriage return chars to text
    let text = encoder.encode('Test de impressao' + '\u000A\u000D');
    return printCharacteristic.writeValue(text).then(() => {
      mostralog.log('Write done.');
    });
  })
  .catch(error => { mostralog(error) });
}
  
  function escreva2(){
    genericDevice.writeTeste2("Um segundo teste testes....testes....testes....testes....testes....testes....testes....testes....")
  }

</script>
